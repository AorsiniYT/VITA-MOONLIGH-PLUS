#!/bin/bash

# Navegar al directorio del proyecto
cd "$(dirname "$0")"

# Construir con Docker
if ! docker info > /dev/null 2>&1; then
    echo "Error: Docker no está corriendo. Inicie el servicio Docker primero."
    exit 1
fi

# Asegurar permisos de directorio
if [ -d "build" ]; then
    sudo chown -R $USER:$USER build
fi

# Verificar dependencias externas
if [ ! -d "library/borealis" ]; then
    echo "Error: Falta el directorio library/borealis. Clone el repositorio borealis primero."
    exit 1
fi

#!/bin/bash

# Configuración
VITA_IP="192.168.0.193"
VITA_PORT="1337"
VITA_CONTROL_PORT="1338"
VPK_NAME="build/borealis_demo.vpk"
VITASHELL_ID="VITASHELL"
TARGET_APP_ID="MLIGHPLUS"

# Función para enviar archivo por FTP
send_ftp() {
    echo "Enviando $1 a $2..."
    curl --ftp-method nocwd -T "$1" "ftp://${VITA_IP}:${VITA_PORT}/$2"
}

# Función para enviar comando de control
send_control() {
    echo "Ejecutando: $1"
    echo "$1" | nc "$VITA_IP" "$VITA_CONTROL_PORT"
}

# Construir con Docker
echo "Construyendo el proyecto..."
sudo docker run --rm -v $(pwd):/src/ xfangfang/vitasdk_sdl2_gles2:latest \
  "cd /src && \
   cmake -B build -G Ninja -DPLATFORM_PSV=ON -DUSE_SYSTEM_SDL2=ON -DCMAKE_BUILD_TYPE=Release && \
   cmake --build build"

# Verificar generación de VPK
if [ ! -f "$VPK_NAME" ]; then
    echo "Error: No se generó el archivo VPK. Archivos en el directorio build:"
    ls -la build/
    exit 1
fi

echo -e "\n¡Archivo VPK generado correctamente!"
ls -lh "$VPK_NAME"

# Enviar VPK a la PS Vita
echo -e "\nEnviando VPK a la PS Vita..."
send_ftp "$VPK_NAME" "ux0:/ABM/"

# Abrir VitaShell
echo -e "\nAbriendo VitaShell..."
send_control "launch $VITASHELL_ID"

echo -e "\n==========================================="
echo "Por favor instala el VPK en VitaShell:"
echo "1. Navega a ux0:/ABM/"
echo "2. Selecciona $(basename "$VPK_NAME") y presiona X"
echo "3. Elige 'Instalar' y confirma"
echo "4. Presiona O para volver al livearea"
echo "5. Presiona cualquier tecla aquí cuando la instalación esté completa"
echo "==========================================="
read -n 1 -s -r -p ""

# Iniciar la aplicación instalada
echo -e "\nIniciando $TARGET_APP_ID..."
send_control "launch $TARGET_APP_ID"

echo "¡Listo!"
sudo chown -R $USER:$USER build

echo "Compilación completada. Archivos generados en el directorio build/"
