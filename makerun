#!/bin/bash

# Navegar al directorio del proyecto
cd "$(dirname "$0")"

echo "[+] Iniciando compilación para PS Vita..."

# Verificar Docker
if ! docker info &>/dev/null; then
    echo "Error: Docker no está en ejecución"
    exit 1
fi

# Configuración
VITA_IP="192.168.0.193"  # Cambia esto por la IP de tu PS Vita
VITA_PORT=1337
VITA_CONTROL_PORT=1338
VPK_PATH="build/borealis_demo.vpk"

# Compilar con Docker
echo "[+] Compilando proyecto..."
mkdir -p build
docker run --rm -v "$(pwd)":/src/ xfangfang/vitasdk_sdl2_gles2:latest \
  "cmake -B build -G Ninja -DPLATFORM_PSV=ON -DUSE_SYSTEM_SDL2=ON -DCMAKE_BUILD_TYPE=Release && \
   cmake --build build"

# Verificar si se generó el VPK
if [ ! -f "$VPK_PATH" ]; then
    echo "[!] Error: No se generó el VPK"
    ls -la build/
    exit 1
fi

VPK_SIZE=$(du -h "$VPK_PATH" | cut -f1)
echo -e "\n[+] Compilación exitosa! VPK: $VPK_PATH ($VPK_SIZE)"

# Enviar a la PS Vita
echo -e "\n[+] Enviando a la PS Vita..."
curl --ftp-method nocwd -T "$VPK_PATH" "ftp://${VITA_IP}:${VITA_PORT}/ux0:/ABM/"

echo -e "\n[+] Abriendo VitaShell..."
echo "launch VITASHELL" | nc "$VITA_IP" "$VITA_CONTROL_PORT"

echo -e "\n==========================================="
echo "Instrucciones:"
echo "1. Ve a ux0:/ABM/ en VitaShell"
echo "2. Instala $(basename "$VPK_PATH")"
echo "3. Presiona O para volver al LiveArea"
echo "4. Presiona ENTER aquí para iniciar la aplicación"
echo "==========================================="

# Esperar a que el usuario termine de instalar
read -p "Presiona ENTER para iniciar la aplicación..."

# Iniciar la aplicación automáticamente
echo -e "\n[+] Iniciando la aplicación (MLIGHPLUS)..."
echo "launch MLIGHPLUS" | nc "$VITA_IP" "$VITA_CONTROL_PORT"
echo "¡Aplicación iniciada! (MLIGHPLUS)"

echo -e "\nCompilación completada. Archivos generados en el directorio build/"
